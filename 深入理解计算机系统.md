## 异常控制流

ECF：现代系统通过使控制流发生突变来对这些系统状态的变化做出反应。这些突变成为异常控制流（ECF）

理解ECF的意义：

* 帮助理解重要的系统概念
* 帮助理解应用程序是如何与操作系统交互的
* 帮助编写有趣的新应用程序
* 帮助理解并发
* 帮助理解软件异常如何工作

### 异常

<img src="C:\Users\whty\AppData\Roaming\Typora\typora-user-images\image-20220120184212396.png" alt="image-20220120184212396" style="zoom:100%;" />

* 异常表，跳转表



### 异常处理

系统中可能的没种类型的异常都分配了一个唯一的非负整数的异常号

异常表的起始地址放在一个叫做异常表基址寄存器的特殊CPU寄存器里。

![image-20220120184612548](C:\Users\whty\AppData\Roaming\Typora\typora-user-images\image-20220120184612548.png)

异常与过程调用的区别：

* 过程调用，返回地址压入栈；异常地址要么是当前指令要么是下一条指令
* 异常的时候会把一些额外的状态压到栈里，以便返回的时候继续调用；
* 异常处理程序运行在内核模式

### 异常的类别

![image-20220120185541956](C:\Users\whty\AppData\Roaming\Typora\typora-user-images\image-20220120185541956.png)

#### Linux/x86_64系统中的异常

256种异常。0~31的号码对应的是Intel架构师定义的异常。	32~255对应操作系统定义的中断和陷阱

![image-20220120190628792](C:\Users\whty\AppData\Roaming\Typora\typora-user-images\image-20220120190628792.png)

* 除法错误（Floating Exception）

* 一般保护故障（Segmentation fault）

* 缺页

* 机器检查

  在x86_64系统上，系统调用是通过一条叫syscall的陷阱指令来提供的

## 8.2 进程

进程的经典定义就是*一个执行中的程序的实例*。

系统中的每个程序都运行在某个进程的上下文中。

上下文由程序正确运行所需的状态组成的。状态包括存放在内存中的程序的代码和数据，它的栈、通用目的寄存器的内容、程序计数器、环境变量以及打开文件描述符的集合

进程提供给应用程序的关键抽象;

* 一个独立的逻辑控制流
* 一个私有的地址空间

###  上下文切换

操作系统内核使用一种成为上下文切换的较高层形式的***异常控制流***来实现多任务

内核为每个进程维持一个上下文。上下文中保存着一些状态。这些状态由一些对象的值组成，包括：通用目的寄存器、浮点寄存器、程序计数器、用户栈、状态寄存器、内核栈和各种内核数据结构，<u>比如描述地址空间的页表、包含有关当前进程信息的进程表，以及包含进程已打开文件的信息的文件表</u>



## 系统调用错误处理

Unix系统级函数遇到错误时，通常会返回-1，并设置全局整数变量errno来表示什么出错了。

使用错误处理包装函数

## 进程控制

